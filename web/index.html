<html>
<head>
<title>Node Bet</title>

<link rel="favicon reloader" href="/favicon.ico?v=3" />

<style>
.noSelect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

body {
    background-image: url("images/carbon_fibre_tile.png");
}

table {
    border-top: 1px solid black;
    border-left: 1px solid black;
}

td {
    border-right: 1px solid black;
    border-bottom: 1px solid black;
    background-color: white;
    padding: 7px;
}

th {
    border-right: 1px solid black;
    border-bottom: 1px solid black;
    background-color: #5da1a3;
    font-weight: normal;
    padding: 10px;
}

.noBg {
    background-color: transparent;
    background-image: none;
}

</style>

<link rel="stylesheet" href="css/alertify.core.css"/>
<link rel="stylesheet" href="css/alertify.default.css"/>

<script src="js/alertify.js"></script>

<script>
"use strict"
var exports = {}
//function require() { return exports }
</script>

<script src="js/sha2.js"></script>
<script src="js/dbl.js"></script>
<script src="js/moment.js"></script>
<script src="js/timestamp.js"></script>
<script src="js/config.js"></script>
<script src="js/logger.js"></script>
<script src="js/utils.js"></script>
<script src="js/quoter.js"></script>
<script src="js/webUtils.js"></script>
<script src="js/observable.js"></script>
<script src="js/sockception/index.js"></script>
<script src="js/sockception/util.js"></script>

<script>

"use strict"

// TODO: Non-chrome testing
// TODO: wtf is all this code doing inside index.html? tsk tsk...

var alertify
var config
var dbl
var hexSha256
var observable
var sockception
var utils // TODO: misnaming: this comes from util.js

// TODO: fix global area pollution
var app = {}
app.log = new exports.logger("debug")
var log = app.log

var randHex = exports.randHex
var clamp = exports.clamp

var username
var chat = null

var tradeElements = []

// TODO: fix magic numbers
var theo = new (function() {
    var self = this

    this.observableValue = new observable(0)

    this.set = this.observableValue.set
    this.get = this.observableValue.get
    this.listen = this.observableValue.listen

    this.change = function(dt) {
        if (ldr.bottomPrice !== null && ldr.topPrice !== null) {
            var newValue = clamp(ldr.bottomPrice, self.get() + dt, ldr.topPrice)
            self.set(newValue)
        }
    }
})

var keyHandlers = []

var isMarketOpen = new observable(false)

var sock = null

var position = 0
var cash = 0
var instrumentCash = 0

var orders = {}

var lotSizes = [1, 2, 5, 10, 20, 50, 100, 200]
var lotIndex = 0

function bindHotkeys() { // TODO: use jwerty or similar
    // d
    keyHandlers[68] = function() { massDelete() }
    
    // Left
    keyHandlers[37] = function() { if (isMarketOpen.get()) qr.changeOffset(-ldr.tickSize) }

    // Up
    keyHandlers[38] = function() { if (isMarketOpen.get()) theo.change(ldr.tickSize) }

    // Right
    keyHandlers[39] = function() { if (isMarketOpen.get()) qr.changeOffset(ldr.tickSize) }

    // Down
    keyHandlers[40] = function() { if (isMarketOpen.get()) theo.change(-ldr.tickSize) }

    // q
    keyHandlers[81] = function() { if (isMarketOpen.get()) qr.toggle() }
    
    // r
    keyHandlers[82] = function() { if (isMarketOpen.get()) qr.refresh() }
    
    // a
    keyHandlers[65] = function() { qr.changeSize(1) }
    
    // z
    keyHandlers[90] = function() { qr.changeSize(-1) }
    
    // s
    keyHandlers[83] = function() { increaseLotSize() }
    
    // x
    keyHandlers[88] = function() { decreaseLotSize() }
    
    // h
    keyHandlers[72] = function() { showHotkeys() }
}

function unbindHotkeys() {
    keyHandlers = []
}

function formatCash(x) {
    if (dbl.equal(x, 0)) {
        x = 0 // Avoids -0.00
    }
    
    return "$" + x.toFixed(2)
}

function getSelectorValue(id) {
    var selector = document.getElementById(id)
    return selector.options[selector.selectedIndex].value
}

function removeElement(node) {
    node.parentNode.removeChild(node)
}

function removeChildren(node) {
    while (node.firstChild) {
        node.removeChild(node.firstChild)
    }
}

function addMessage(msg) {
    var msgDiv = document.createElement("div")
    msgDiv.appendChild(document.createTextNode(msg))
    msgDiv.style.margin = "10px"
    msgDiv.style.wordWrap = "break-word"
    
    var cc = document.getElementById("chatDisplay")
    cc.appendChild(msgDiv)
    cc.scrollTop = cc.scrollHeight
}

function addErrorMessage(msg) {
    var msgDiv = document.createElement("div")
    msgDiv.appendChild(document.createTextNode(msg))
    msgDiv.style.margin = "10px"
    msgDiv.style.wordWrap = "break-word"
    msgDiv.style.color = "red"
    
    var cc = document.getElementById("chatDisplay")
    cc.appendChild(msgDiv)
    cc.scrollTop = cc.scrollHeight
}

function showHotkeys() {
    alertify.alert(
        "d: delete all orders<br>" +
        "s: increment click lot size<br>" +
        "x: decrement lot size<br>" +
        "up arrow: increment theo<br>" +
        "down arrow: decrement theo<br>" +
        "q: toggle quoter<br>" +
        "left arrow: tighten quoter<br>" +
        "right arrow: widen quoter<br>" +
        "a: increment quoter size<br>" +
        "z: decrement quoter size<br>" +
        "r: refill quotes<br>" +
        "h: show hotkeys")
}

document.onkeydown = function(e) {
    if (keyHandlers[e.keyCode]) {
        e.preventDefault()
        keyHandlers[e.keyCode]()
    }
}

function sendOrderInsert(side, price, volume, tradeCb, tagCb) {
    price = ldr.normalizePrice(price)
    
    var order = {
        instrumentName: "testInstrument",
        price: price,
        volume: volume,
        side: side,
        expiry: null
    }
    
    order.sock = sock.route("orderInsert").send(order)

    order.sock.route("tag").receiveOne(function(tag) { // TODO: tags should be obsolete now
        order.tag = tag.value
        orders[tag.value] = order
        
        order.orderStatus = "active"
        order.webElements.statusCell.innerHTML = "active"

        // TODO: do this better
        if (tagCb) {
            tagCb()
        }
    })

    order.sock.route("trade").receiveMany(function(tradeSock, stop) {
        var trade = tradeSock.value

        position += (order.side === "buy" ? 1 : -1) * trade.volume
        cash += (order.side === "buy" ? -1 : 1) * trade.price * trade.volume
        
        document.getElementById("posDisplay").innerHTML = position
        document.getElementById("posDisplay").style.backgroundColor = (order.side === "buy" ? "#88FF88" : "FF8888")
        
        // TODO: Need to clear timeout if a new pos change comes in
        setTimeout(
            function()
            {
                document.getElementById("posDisplay").style.backgroundColor = ""
            },
            500)
        
        document.getElementById("cashDisplay").innerHTML = formatCash(cash + instrumentCash)
        updateValuation() // Takes care of valuation change. TODO: Do this better.
        
        createTrade(
            order.side,
            trade.price,
            trade.volume)
        
        order.volume -= trade.volume
        order.webElements.volumeCell.innerHTML = order.volume
        
        if (order.volume === 0) {
            order.orderStatus = "fully traded"
            order.webElements.statusCell.innerHTML = order.orderStatus
            
            stop()

            setTimeout(
                function()
                {
                    removeElement(order.webElements.row)
                    delete orders[order.tag]
                },
                500)
        }
        
        if (tradeCb) {
            tradeCb()
        }
    })

    order.sock.route("deleted").receiveOne(function() {
        handleOrderDeleted(order)
    })

    order.sock.route("error").receiveMany(function(error) {
        order.orderStatus = "rejected"
        order.webElements.statusCell.innerHTML = "rejected"

        alertify.error(error.value)
        
        setTimeout(
            function()
            {
                removeElement(order.webElements.row) // TODO: is this ok to call multiple times?
                delete orders[order.tag]
            },
            500)
    })

    order.tag = null
    
    createOrder(order)
    
    return order
}

function createOrder(order) {
    order.orderStatus = "pending"
    order.isFinished = function() {
        return (order.orderStatus !== "active" && order.orderStatus !== "pending")
    }
    
    order.webElements = {}
    order.webElements.row = document.createElement("tr")
    order.webElements.sideCell = document.createElement("td")
    order.webElements.priceCell = document.createElement("td")
    order.webElements.volumeCell = document.createElement("td")
    order.webElements.statusCell = document.createElement("td")
    order.webElements.removeCell = document.createElement("td")
    
    order.webElements.row.appendChild(order.webElements.sideCell)
    order.webElements.row.appendChild(order.webElements.priceCell)
    order.webElements.row.appendChild(order.webElements.volumeCell)
    order.webElements.row.appendChild(order.webElements.statusCell)
    order.webElements.row.appendChild(order.webElements.removeCell)
    
    order.webElements.sideCell.innerHTML = order.side
    order.webElements.priceCell.innerHTML = dbl.toString(order.price)
    order.webElements.volumeCell.innerHTML = order.volume
    order.webElements.statusCell.innerHTML = order.orderStatus
    order.webElements.removeCell.innerHTML = "x"
    
    order.webElements.removeCell.onclick = function() {
        sendDelete(order.tag, false)
    }
    
    for (var key in order.webElements) {
        if (key !== "row") {
            order.webElements[key].align = "center"
            order.webElements[key].style.padding = 2
        }
    }
    
    insertAfter(document.getElementById("orderHeadings"), order.webElements.row)
}

function createTrade(side, price, volume) {
    price = Math.round(100 * price) / 100
    
    var elements = {}
    elements.row = document.createElement("tr")
    elements.sideCell = document.createElement("td")
    elements.priceCell = document.createElement("td")
    elements.volumeCell = document.createElement("td")
    
    elements.row.appendChild(elements.sideCell)
    elements.row.appendChild(elements.priceCell)
    elements.row.appendChild(elements.volumeCell)
    
    elements.sideCell.innerHTML = side
    elements.priceCell.innerHTML = dbl.toString(price)
    elements.volumeCell.innerHTML = volume
    
    for (var key in elements) {
        if (key !== "row") {
            elements[key].align = "center"
            elements[key].style.padding = 2
        }
    }
    
    insertAfter(document.getElementById("tradeHeadings"), elements.row)

    tradeElements.push(elements)
}

function clearTrades() {
    for (var i in tradeElements) {
        removeElement(tradeElements[i].row)
    }

    tradeElements = []
}

function sendDelete(tag, fromQuoter) {
    var order = orders[tag]

    // TODO: make better
    if (!fromQuoter) {
        if (order === qr.bidOrder || order === qr.offerOrder) {
            return
        }
    }
    
    //console.log("sendDelete(\"" + tag + "\")")
    if (order && order.orderStatus !== "deleting" && order.orderStatus !== "deleted") {
        //console.log("actually sendDelete(\"" + tag + "\"), status: " + orders[tag].orderStatus)
        
        order.orderStatus = "deleting"
        order.webElements.statusCell.innerHTML = "deleting"
        
        // TODO: argh why sock and not order.sock?
        var orderDelete = sock.route("orderDelete").send(tag)

        orderDelete.route("success").receiveOne(function() {
            handleOrderDeleted(order)
        })

        orderDelete.route("failure").receiveOne(function() {
            console.log("Tried to delete order not found at exchange (probably traded)")
        })
    }
}

function handleOrderDeleted(order) {
    if (order.orderStatus === "deleted") {
        return
    }
    
    order.orderStatus = "deleted"
    order.webElements.statusCell.innerHTML = "deleted"
    
    setTimeout(
        function()
        {
            removeElement(order.webElements.row)
            delete orders[order.tag]
        },
        500)
}

function ladder(tableNode) {
    var self = this

    this.tableNode = tableNode

    this.decimalPlaces = null

    this.bottomPrice = null
    this.tickSize = null
    this.topPrice = null
    
    this.bidCells = null
    this.priceCells = null
    this.offerCells = null

    this.description = "<font color=\"grey\">[Closed]</font>"
    this.descriptionCell = null

    this.setDescription = function(description) {
        self.description = description
        self.descriptionCell.innerHTML = description
    }

    this.build = function(bottomPrice, tickSize, topPrice) {
        log.debug("Building ladder")

        self.cleanup()
        self.buildHeader()

        self.decimalPlaces = dbl.decimalsUsed(tickSize)

        self.bottomPrice = bottomPrice
        self.tickSize = tickSize
        self.topPrice = topPrice

        self.bidCells = new dbl.map()
        self.priceCells = new dbl.map()
        self.offerCells = new dbl.map()
        
        for (var price = self.topPrice; price >= self.bottomPrice - 0.5 * tickSize; price -= tickSize) {
            self.buildLevel(price, tickSize)
        }

        self.priceCells.get(theo.get()).style.backgroundColor = "#88bbff"

        theo.listen(function(theo, oldTheo) {
            // TODO: assumes theo is on a tick (need nearest tick)
            self.priceCells.get(oldTheo).style.backgroundColor = "#ffffff"
            self.priceCells.get(theo).style.backgroundColor = "#88bbff"
        })
    }

    this.buildHeader = function() {
        self.tableNode.innerHTML = [
            "<tr>",
            "    <th width=210 colspan=3 align=\"center\" id=\"descriptionDisplay\"></th>",
            "</tr>",
            "<tr>",
            "    <td width=70 align=\"center\">Bid</td>",
            "    <td width=70 align=\"center\">Price</td>",
            "    <td width=70 align=\"center\">Offer</td>",
            "</tr>"
        ].join("\n")

        self.descriptionCell = document.getElementById("descriptionDisplay")
        self.descriptionCell.innerHTML = self.description
    }

    this.buildLevel = function(price, tickSize) {
        if (dbl.equal(price, 0)) {
            price = 0 // Avoids printing prices like "-0.00"
        }
        
        var row = document.createElement("tr")
        var bidCell = document.createElement("td")
        var priceCell = document.createElement("td")
        var offerCell = document.createElement("td")
        
        bidCell.align = "center"
        priceCell.align = "center"
        offerCell.align = "center"
        
        priceCell.innerHTML = price.toFixed(self.decimalPlaces)
        
        row.appendChild(bidCell)
        row.appendChild(priceCell)
        row.appendChild(offerCell)
        
        self.tableNode.appendChild(row)
        
        self.bidCells.set(price, bidCell)
        self.priceCells.set(price, priceCell)
        self.offerCells.set(price, offerCell)
        
        bidCell.onclick = function() {
            sendOrderInsert("buy", price, lotSizes[lotIndex])
        }
        
        offerCell.onclick = function() {
            sendOrderInsert("sell", price, lotSizes[lotIndex])
        }
    }

    this.normalizePrice = function(price) {
        var priceStr = price.toFixed(self.decimalPlaces)
        return parseFloat(priceStr)
    }

    this.cleanup = function() {
        self.bidCells = null
        self.priceCells = null
        self.offerCells = null
        removeChildren(self.tableNode)
        self.buildHeader()
    }

    this.buildHeader()
}

var ldr = null
var qr = null

window.onload = function() {
    ldr = new ladder(document.getElementById("ladderTable"))
    
    qr = new quoter()
    
    document.getElementById("startupTable").onkeydown = function(e) {
        if (e.keyCode === 13) {
            switch (getSelectorValue("startupSelector")) {
                case "login":
                    login()
                    break
                
                case "register":
                    register()
                    break
                
                case "changePassword":
                    changePassword()
                    break
            }
        }
    }
    
    document.getElementById("usernameInput").focus()
    
    qr.updateDisplay()
    
    var chatInput = document.getElementById("chatInput")
    chatInput.onkeydown = function(e) {
        if (e.keyCode === 13) {
            if (chat === null) {
                addErrorMessage("Chat not connected")
            } else {
                chat.send(chatInput.value)
            }
            
            chatInput.value = ""
            
            return false
        }
        
        return true
    }
}

function increaseLotSize() {
    lotIndex++
    if (lotIndex >= lotSizes.length) {
        lotIndex = lotSizes.length - 1
    }
    
    document.getElementById("lotSizeDisplay").innerHTML = lotSizes[lotIndex]
}

function decreaseLotSize() {
    lotIndex--
    if (lotIndex < 0) {
        lotIndex = 0
    }
    
    document.getElementById("lotSizeDisplay").innerHTML = lotSizes[lotIndex]
}

function updateValuation() {
    document.getElementById("valuationDisplay").innerHTML = formatCash(cash + instrumentCash + theo.get() * position)
}

theo.listen(updateValuation)

function massDelete() {
    //peer.get("massDelete", null, {}) // Currently ignoring ack
    for (var tag in orders) {
        sendDelete(parseInt(tag), false)
    }
}

function login() {
    username = document.getElementById("usernameInput").value
    
    var sockConnectedAtStart = !!sock

    if (!sock) {
        sock = sockception.connect("ws://" + config.host + ":" + config.port + "/", log)

        // TODO: don"t use impl / expose this kind of thing properly
        sock.impl.factory.log = function() {
            var str = ""
            for (var i = 0; i !== arguments.length; i++) {
                if (i !== 0) {
                    str += " "
                }
                str += JSON.stringify(arguments[i])
            }
            console.debug("sockception: " + str)
        }
    }
    
    var run = function() {
        sock.route("clueRequest").send(username).receiveOne(function(clue) {
            var startupType = getSelectorValue("startupSelector")
            
            var passwd = document.getElementById(
                startupType === "login" ?
                "loginPasswordInput" :
                "changePasswordOldPasswordInput").value
            
            var newPasswd = document.getElementById(
                startupType === "login" ?
                "loginPasswordInput" :
                "changePasswordNewPasswordInput").value
            
            var hash = hexSha256(clue.value + passwd)
            var nextClue = randHex()
            
            var loginRequest = sock.route("loginRequest").send({
                uname: username,
                hash: hash,
                nextClue: nextClue,
                nextDoubleHash: hexSha256(hexSha256(nextClue + newPasswd))
            })
            
            loginRequest.route("success").receiveOne(handleLogin)

            loginRequest.route("failure").receiveOne(function() {
                var failureElement = (
                    getSelectorValue("startupSelector") === "login" ?
                    document.getElementById("loginPasswordInput") :
                    document.getElementById("changePasswordOldPasswordInput"))
                
                failureElement.value = "login failure"
                failureElement.type = "text"
                
                setTimeout(
                    function()
                    {
                        failureElement.value = ""
                        failureElement.type = "password"
                    },
                    500)
            })

            loginRequest.route("alreadyLoggedIn").receiveOne(function() {
                var failureElement = document.getElementById("usernameInput")
                failureElement.value = "already logged in"
                
                setTimeout(
                    function()
                    {
                        failureElement.value = ""
                    },
                    500)
            })
        })
    }

    if (sockConnectedAtStart) {
        run()
    } else {
        sock.receiveOne(run)
    }
}

function handleLogin(newSocket) {
    sock = newSocket // TODO: oh dear, this needs to be done in a better way

    switch(getSelectorValue("startupSelector")) {
        case "login":
            document.getElementById("loginPasswordInput").value = "login success!"
            document.getElementById("loginPasswordInput").type = "text"
            break
        
        case "register":
            document.getElementById("registerRegistrationKeyInput").value = "login success!"
            break
        
        case "changePassword":
            document.getElementById("changePasswordOldPasswordInput").value = "login success!"
            document.getElementById("changePasswordOldPasswordInput").type = "text"
            
            document.getElementById("changePasswordNewPasswordInput").value = "login success!"
            document.getElementById("changePasswordNewPasswordInput").type = "text"
            
            document.getElementById("changePasswordConfirmNewPasswordInput").value = "login success!"
            document.getElementById("changePasswordConfirmNewPasswordInput").type = "text"
            break
    }
    
    if (username === "andrew.morris") { // TODO: configure this lol
        var openInstrumentButton = document.createElement("input")
        openInstrumentButton.value = "Open"
        openInstrumentButton.type = "button"
        
        openInstrumentButton.onclick = function() {
            unbindHotkeys()
            
            // TODO: I need to outlaw this technique
            alertify.prompt("Enter description", function(e, desc) {
            alertify.prompt("Enter bottom price", function(e, bottomPrice) {
            alertify.prompt("Enter tick size", function(e, tickSize) {
            alertify.prompt("Enter top price", function(e, topPrice) {
                
                bindHotkeys()

                bottomPrice = parseFloat(bottomPrice)
                tickSize = parseFloat(tickSize)
                topPrice = parseFloat(topPrice)
                
                var openInstrument = sock.route("openInstrument").send({
                    instrumentName: "testInstrument",
                    description: desc,
                    tickTable: {
                        bottomPrice: bottomPrice,
                        tickSize: tickSize,
                        topPrice: topPrice
                    }
                })

                openInstrument.route("error").receiveMany(function(s) {
                    alertify.error(s.value)
                })

                openInstrument.route("success").receiveOne(function() {
                    // TODO: should something go here?
                })
                
            })})})})
        }
        
        document.getElementById("adminDisplay").appendChild(openInstrumentButton)
        
        var closeInstrumentButton = document.createElement("input")
        closeInstrumentButton.value = "Close"
        closeInstrumentButton.type = "button"
        
        closeInstrumentButton.onclick = function() {
            unbindHotkeys()
            
            alertify.prompt("Enter settlement price", function(e, price) {
                bindHotkeys()
                
                var closeInstrument = sock.route("closeInstrument").send({
                    instrumentName: "testInstrument",
                    value: parseFloat(price)
                })

                closeInstrument.route("error").receiveMany(function(err) {
                    alertify.error(err.value)
                })

                closeInstrument.route("success").receiveOne(function() {
                    // TODO: do something here?
                })
            })
        }
        
        document.getElementById("adminDisplay").appendChild(closeInstrumentButton)
        
        var regoKeyButton = document.createElement("input")
        regoKeyButton.value = "Request Registration Key"
        regoKeyButton.type = "button"
        
        regoKeyButton.onclick = function() {
            sock.route("clueRequest").send(username).receiveOne(function(clue) {
                unbindHotkeys()

                alertify.prompt("Password", function(e, passwd) {
                alertify.prompt("New username", function(e, newUser) {
                    bindHotkeys()

                    var nextClue = utils.randHex()
                    
                    var rkr = sock.route("registrationKeyRequest").send({
                        hash: hexSha256(clue + passwd),
                        nextClue: nextClue,
                        nextDoubleHash: hexSha256(hexSha256(nextClue + passwd)),
                        newUser: newUser
                    })

                    rkr.route("registrationKey").receiveOne(function(key) {
                        alertify.alert(key.value)
                    })

                    rkr.route("failure").receiveOne(function() {
                        alertify.error("Wrong password")
                    })
                })})
            })
        }
        
        document.getElementById("adminDisplay").appendChild(regoKeyButton)

        var forceQuotersButton = document.createElement("input")
        forceQuotersButton.value = "Turn Quoters On"
        forceQuotersButton.type = "button"

        forceQuotersButton.onclick = function() {
            sock.route("forceQuotersOn").send("testInstrument")
        }
        
        document.getElementById("adminDisplay").appendChild(forceQuotersButton)
        document.getElementById("adminDisplay").appendChild(document.createElement("br"))
    }
    
    setTimeout(
        function() {
            bindHotkeys()
            
            // TODO: (Random thought) What does the server do if you insert a 0.5 lot?
            
            removeElement(document.getElementById("startupTable"))
            document.getElementById("innerLayoutTable").style.visibility = "visible"

            createLoginRequests()
        },
        500)
    
    var pingInterval = setInterval(
        function() {
            var sendTime = new Date()

            sock.route("ping").send().receiveOne(function() {
                log.info("Ping time: " + (new Date() - sendTime) + "ms")
            })
        },
        10000)

    sock.onclose(function() {
        clearInterval(pingInterval)
    })
}

function createLoginRequests()
{
    sock.route("cash").send().receiveOne(function(cashUpdate) {
        cash = cashUpdate.value
        document.getElementById("cashDisplay").innerHTML = formatCash(cash + instrumentCash)
        updateValuation()
    })

    chat = sock.route("chat").send()

    chat.receiveMany(function(msgInfo) {
        addMessage(msgInfo.value.uname + ": " + msgInfo.value.msg)
    })

    var instrumentSubscription = sock.route("instrumentSubscription").send("testInstrument")
    
    instrumentSubscription.route("positionUpdate").receiveMany(function(positionUpdate) {
        instrumentCash = positionUpdate.value.cash
        document.getElementById("cashDisplay").innerHTML = formatCash(cash + instrumentCash)
        
        position = positionUpdate.value.instrument
        document.getElementById("posDisplay").innerHTML = position
        
        updateValuation()
    })

    instrumentSubscription.route("priceUpdate").receiveMany(function(priceUpdate) {
        var pu = priceUpdate.value

        if (pu.volume > 0) {
            ldr.bidCells.get(pu.price).innerHTML = pu.volume
        } else if (pu.volume < 0) {
            ldr.offerCells.get(pu.price).innerHTML = -pu.volume
        } else {
            ldr.bidCells.get(pu.price).innerHTML = ""
            ldr.offerCells.get(pu.price).innerHTML = ""
        }
    })

    instrumentSubscription.route("status").receiveMany(function(status) {
        var is = status.value
        
        var isMarketOpenBefore = isMarketOpen.get()
        isMarketOpen.set(is.instrumentStatus === "open")

        if (!isMarketOpenBefore && isMarketOpen.get()) {
            ldr.build(
                is.tickTable.bottomPrice,
                is.tickTable.tickSize,
                is.tickTable.topPrice)
            
            qr.setup()
            
            document.getElementById("descriptionDisplay").innerHTML = is.description
        }
    })

    instrumentSubscription.route("open").receiveOne(function(open) {
        var op = open.value

        clearTrades()

        ldr.build(
            op.tickTable.bottomPrice,
            op.tickTable.tickSize,
            op.tickTable.topPrice)
        
        theo.set(0.5 * (op.tickTable.bottomPrice + op.tickTable.topPrice))
        isMarketOpen.set(true)

        qr.setup()
        
        document.getElementById("descriptionDisplay").innerHTML = op.description
    })

    instrumentSubscription.route("close").receiveOne(function(close) {
        isMarketOpen.set(false)
        theo.set(0)
        document.getElementById("descriptionDisplay").innerHTML = "<font color=\"grey\">[Closed]</font>"

        cash += instrumentCash
        instrumentCash = 0

        cash += position * close.value // TODO: cash is an observable
        position = 0
        updateValuation()
        document.getElementById("posDisplay").innerHTML = position
        document.getElementById("cashDisplay").innerHTML = formatCash(cash + instrumentCash)

        ldr.cleanup()
    })

    instrumentSubscription.route("error").receiveMany(function(error) {
        alertify.alert(error.value)
    })

    instrumentSubscription.route("forceQuoterOn").receiveMany(function() {
        qr.toggle()
    })
}

function register() {
    var confirmField = document.getElementById("registerConfirmPasswordInput")
    
    if (
        document.getElementById("registerPasswordInput").value !==
        confirmField.value
    ) {
        confirmField.value = "doesn\"t match"
        confirmField.type = "text"
        
        setTimeout(
            function() {
                confirmField.value = ""
                confirmField.type = "password"
            },
            500)
        
        return
    }
    
    var uname = document.getElementById("usernameInput").value

    sock.route("clueRequest").send(uname).receiveOne(function(clue) {
        var regoKeyField = document.getElementById("registerRegistrationKeyInput")
        var nextClue = randHex()
        
        var registrationRequest = sock.route("registrationRequest").send({
            doubleHash: hexSha256(regoKeyField.value + clue.value),
            nextClue: nextClue,
            nextDoubleHash: hexSha256(hexSha256(nextClue + document.getElementById("registerPasswordInput").value))
        })

        registrationRequest.route("success").receiveOne(handleLogin)

        registrationRequest.route("failure").receiveOne(function() {
            regoKeyField.value = "failure"

            setTimeout(
                function() {
                    regoKeyField.value = ""
                },
                500) // TODO: config
        })
    })
}

function changePassword() {
    var newPasswordInput = document.getElementById("changePasswordNewPasswordInput")
    var confirmNewPasswordInput = document.getElementById("changePasswordConfirmNewPasswordInput")
    
    if (newPasswordInput.value !== confirmNewPasswordInput.value) {
        confirmNewPasswordInput.value = "doesn\"t match"
        confirmNewPasswordInput.type = "text"
        
        setTimeout(
            function() {
                confirmNewPasswordInput.value = ""
                confirmNewPasswordInput.type = "password"
            },
            500)
        
        return
    }
    
    login()
}

function updateStartupTable() {
    var rowIds = {
        login: ["loginRow1"],
        register: ["registerRow1", "registerRow2", "registerRow3"],
        changePassword: ["changePasswordRow1", "changePasswordRow2", "changePasswordRow3"]
    }
    
    for (var displayType in rowIds) {
        var displayValue = (displayType === getSelectorValue("startupSelector") ? "" : "none")
        
        for (var i in rowIds[displayType]) {
            document.getElementById(rowIds[displayType][i]).style.display = displayValue
        }
    }
}

</script>

</head>
<body style="font-family:consolas,courier new;margin:0" class="noSelect">

<a href="/"><img style="position:absolute;top:50;left:50%;margin-top:-35px;margin-left:-35px;width:70px;height:70px;" src="images/logo.png"/></a>

<table cellspacing=0 id="mainTable" width="100%">

<tr><td style="background-color:#16383f;height:50px;border-bottom:none;"></td></tr>
<tr><td style="background-color:#dcedf0;height:10px;padding:0px;"></td></tr>
<tr><td style="height:25px;border-bottom:none" class="noBg"></td></tr>

<tr><td class="noBg">

<table style="border:none" align="center" id="startupTable"><tr><td style="border:none;background-color:transparent"><table cellspacing=0 align="center">
    <tr>
        <th colspan=2 align="center">
            <select id="startupSelector" style="font-size:16px" onchange="updateStartupTable()">
                <option value="login">Login</option>
                <option value="register">Register</option>
                <option value="changePassword">Change Password</option>
            </select>
        </th>
    </tr>
    <tr>
        <td>Username</td>
        <td><input type="text" id="usernameInput"/></td>
    </tr>
    <!-- Login -->
    <tr id="loginRow1">
        <td>Password</td>
        <td><input type="password" id="loginPasswordInput"/></td>
    </tr>
    <!-- Register -->
    <tr id="registerRow1" style="display:none">
        <td>Registration Key</td>
        <td><input type="text" id="registerRegistrationKeyInput"/></td>
    </tr>
    <tr id="registerRow2" style="display:none">
        <td>Password</td>
        <td><input type="password" id="registerPasswordInput"/></td>
    </tr>
    <tr id="registerRow3" style="display:none">
        <td>Confirm Password</td>
        <td><input type="password" id="registerConfirmPasswordInput"/></td>
    </tr>
    <!-- Change Password -->
    <tr id="changePasswordRow1" style="display:none">
        <td>Old Password</td>
        <td><input type="password" id="changePasswordOldPasswordInput"/></td>
    </tr>
    <tr id="changePasswordRow2" style="display:none">
        <td>New Password</td>
        <td><input type="password" id="changePasswordNewPasswordInput"/></td>
    </tr>
    <tr id="changePasswordRow3" style="display:none">
        <td>Confirm New Password</td>
        <td><input type="password" id="changePasswordConfirmNewPasswordInput"/></td>
    </tr>
</table></td></tr></table>

<table align="center" cellpadding="20" width="100%" style="visibility:hidden;border:0" id="innerLayoutTable"><tr><td class="noBg" width="33%" valign="top" style="border:0">

<table align="center" cellspacing=0 id="lotSizeSelector" width="100%">
    <tr>
        <th colspan=3 align="center">Position</th>
    </tr>
    <tr>
        <td align="center" width="33%">Cash</td>
        <td align="center" width="34%">Contracts</td>
        <td align="center" width="33%">Valuation</td>
    </tr>
    <tr>
        <td align="center" width="33%" id="cashDisplay"></td>
        <td align="center" width="34%" id="posDisplay"></td>
        <td align="center" width="33%" id="valuationDisplay"></td>
    </tr>
</table>
<br>

<div id="adminDisplay" align="center"></div>

<br>

<!-- Chat -->
<table align="center" cellspacing=0 cellpadding=0 width="100%">
    <tr>
        <th align="center" style="padding:10;">
            Chat 
        </th>
    </tr>
    <tr>
        <td height=300 width="100%">
            <div id="chatDisplay" style="width:100%;height:100%;overflow:auto;word-wrap:break-word;"></div> 
        </td>
    </tr>
    <tr>
        <td style="padding:0px">
            <textarea id="chatInput" style="width:100%;height:100%;border:0;" onfocus="unbindHotkeys()" onblur="bindHotkeys()"></textarea>
        </td>
    </tr>
</table>

</td><td class="noBg" width="34%" valign="top" style="border:0">

<table align="center" cellspacing=0 id="ladderTable" frame="box" rules="all">
</table>

</td><td class="noBg" width="33%" valign="top" style="border:0">

<table align="center" cellspacing=0 id="lotSizeSelector" style="width:100%">
    <tr>
        <th colspan=3 align="center">Lot Size</th>
    </tr>
    <tr>
        <td width="33%" align="center" onclick="decreaseLotSize()">-</td>
        <td width="34%" align="center" id="lotSizeDisplay">1</td>
        <td width="33%" align="center" onclick="increaseLotSize()" unselectable="on">+</td>
    </tr>
</table>

<br>

<table align="center" cellspacing=0 id="quoterTable" style="width:100%">
    <tr>
        <th colspan=3 align="center">Quoter</th>
    </tr>
    <tr>
        <td width="33%" align="center">On</td>
        <td width="34%" align="center">Offset</td>
        <td width="33%" align="center">Size</td>
    </tr>
    <tr>
        <td align="center" id="quoterOnDisplay"></td>
        <td align="center" id="quoterOffsetDisplay"></td>
        <td align="center" id="quoterSizeDisplay"></td>
    </tr>
</table>

<br>

<div style="width:100%;height:300;overflow:auto;background-color:white;">
    <table align="center" cellspacing=0 id="orderTable" width="100%">
        <tr>
            <th colspan=5 align="center">Orders</th>
        </tr>
        <tr id="orderHeadings">
            <td align="center" width="15%">Side</td>
            <td align="center" width="17%">Price</td>
            <td align="center" width="20%">Volume</td>
            <td align="center" width="37%">Status</td>
            <td align="center" width="11%" onclick="massDelete()">x</td>
        </tr>
    </table>
</div>

<br>

<div style="width:100%;height:300;overflow:auto;background-color:white;">
    <table align="center" cellspacing=0 id="tradeTable" width="100%">
        <tr>
            <th colspan=5 align="center">Trades</th>
        </tr>
        <tr id="tradeHeadings">
            <td align="center" width="33%">Side</td>
            <td align="center" width="34%">Price</td>
            <td align="center" width="33%">Volume</td>
        </tr>
    </table>
</div>

</td></tr></table>

</td></tr></table>

</body>
</html>
